<script>
(function() {
    // Flag to tell us if we've killed images yet
    var killed = 0;

    // Map killed states (1 or 0) to button titles and icons
    var titles = {
        0: 'Kill Images',
        1: 'Restore Images'
    };
    var icons = {
        0: 'images/icon32.png',
        1: 'images/restore32.png'
    };

    // Updates the title and icon of the button depending on the killed state
    function updateButton() {
        chrome.browserAction.setTitle({title: titles[killed]});
        chrome.browserAction.setIcon({path: icons[killed]});
    }

    // Handle button clicks
    chrome.browserAction.onClicked.addListener(function(tab) {
        if (!killed) {
            chrome.tabs.insertCSS(null, { file: 'css/kill.css' });
        } else {
            chrome.tabs.executeScript(null, { file: 'js/restore.js' });
        }
        killed = killed ? 0 : 1;
        updateButton();
    });

    // Wire up events to reset our internal state when we're looking at a
    // new tab or window. FIXME: This will forget the state of tabs for which
    // we've already killed images.
    function reset(tab) {
        killed = 0;
        updateButton();
    }
    chrome.tabs.onSelectionChanged.addListener(reset);
    chrome.windows.onFocusChanged.addListener(reset);

    // Set the initial state of the button when we're first loaded.
    updateButton();
})();
</script>
